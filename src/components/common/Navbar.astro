---
import Logo from "./Logo.astro";
import HamburgerButton from "./HamburgerButton.astro";
import DarkModeToggle from "./DarkModeToggle.astro";
import LinksNavbar from "./LinksNavbar.astro";
import { navbarLinks } from "../../js/navbarLinks";
---

<style>
  ul li a.active{
    color: var(--color-primary);
  }
</style>

<nav class="bg-background dark:bg-dark-background fixed w-full top-0 start-0 border-b border-gray-200 dark:border-dark-border z-50">
  <div class="max-w-screen-xl flex flex-wrap items-center justify-between mx-auto p-4">
    <Logo />
    <div class="flex lg:order-2 space-x-3 lg:space-x-0 rtl:space-x-reverse items-center lg:gap-6 gap-2">
        <button id="toggleSnow" class="cursor-pointer">
          <img src="/christmas/snowflake.png" alt="" class="w-5 h-5">
        </button>
        <DarkModeToggle />
        <HamburgerButton />
    </div>
    <LinksNavbar links={ navbarLinks }/>
  </div>
</nav>


<script>
  // Función para inicializar todo
  function initNavbar() {
    const toggleButton = document.querySelector('[data-collapse-toggle]') as HTMLElement;
    const menu = document.getElementById('navbar-default');

    if (!toggleButton || !menu) return;

    // Cerrar menú al hacer click fuera
    document.addEventListener('click', (event) => {
      const target = event.target as Node;
      const isClickInside = toggleButton.contains(target) || menu.contains(target);
      const isVisible = !menu.classList.contains('hidden');

      if (!isClickInside && isVisible) {
        toggleButton.click();
      }
    });

    // Cerrar menú al hacer click en enlaces (mobile)
    const navLinks = menu.querySelectorAll('a');
    navLinks.forEach(link => {
      link.addEventListener('click', () => {
        if (window.innerWidth < 1024 && !menu.classList.contains('hidden')) {
          toggleButton.click();
        }
      });
    });
  }

  // Marcar enlace activo según la URL
  function setActiveLink() {
    const currentUrl = window.location.pathname + window.location.hash;
    const links = document.querySelectorAll('#navbar-default a');

    links.forEach(link => {
      const href = link.getAttribute('href');
      link.classList.remove('active');

      if (href === currentUrl || href === window.location.pathname) {
        link.classList.add('active');
      }
    });
  }

  // Toggle de copos de nieve
  function initSnowToggle() {
    const btn = document.getElementById("toggleSnow") as HTMLElement;
    const snow = document.getElementById("snowflakes");

    if (!btn || !snow) return;

    // Restaurar estado guardado
    const snowActive = localStorage.getItem("snow-active");
    if (snowActive === "0") {
      snow.classList.add("hidden");
    }

    btn.addEventListener("click", () => {
      snow.classList.toggle("hidden");
      localStorage.setItem("snow-active", snow.classList.contains("hidden") ? "0" : "1");
    });
  }

  // Inicializar todo cuando el DOM esté listo
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', () => {
      initNavbar();
      setActiveLink();
      initSnowToggle();
    });
  } else {
    // DOM ya está listo
    initNavbar();
    setActiveLink();
    initSnowToggle();
  }

  // Actualizar enlace activo en cambios de hash
  window.addEventListener('hashchange', setActiveLink);

  // Re-inicializar después de navegación (para SPAs de Astro)
  document.addEventListener('astro:page-load', () => {
    initNavbar();
    setActiveLink();
    initSnowToggle();
  });
</script>