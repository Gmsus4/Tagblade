---
import Logo from "./Logo.astro";
import HamburgerButton from "./HamburgerButton.astro";
import DarkModeToggle from "./DarkModeToggle.astro";
import LinksNavbar from "./LinksNavbar.astro";
import { navbarLinks } from "../../js/navbarLinks";
---

<style>
  ul li a.active{
    color: var(--color-primary);
  }
</style>

<nav class="bg-background dark:bg-dark-background fixed w-full top-0 start-0 border-b border-gray-200 dark:border-dark-border z-50">
  <div class="max-w-screen-xl flex flex-wrap items-center justify-between mx-auto p-4">
    <Logo />
    <div class="flex lg:order-2 space-x-3 lg:space-x-0 rtl:space-x-reverse items-center lg:gap-6 gap-2">
        <DarkModeToggle />
        <HamburgerButton />
    </div>
    <LinksNavbar links={ navbarLinks }/>
  </div>
</nav>


<script>
  // Función para inicializar todo
  function initNavbar() {
    const toggleButton = document.querySelector('[data-collapse-toggle]') as HTMLElement;
    const menu = document.getElementById('navbar-default');

    if (!toggleButton || !menu) return;

    // Cerrar menú al hacer click fuera
    document.addEventListener('click', (event) => {
      const target = event.target as Node;
      const isClickInside = toggleButton.contains(target) || menu.contains(target);
      const isVisible = !menu.classList.contains('hidden');

      if (!isClickInside && isVisible) {
        toggleButton.click();
      }
    });

    // Cerrar menú al hacer click en enlaces (mobile)
    const navLinks = menu.querySelectorAll('a');
    navLinks.forEach(link => {
      link.addEventListener('click', () => {
        if (window.innerWidth < 1024 && !menu.classList.contains('hidden')) {
          toggleButton.click();
        }
      });
    });
  }

  // Marcar enlace activo según la URL
  function setActiveLink() {
    // Normalizar URLs (quitar barra final para comparar)
    const normalize = (url: string) => url.replace(/\/$/, '') || '/';
    
    const currentPath = normalize(window.location.pathname);
    const currentHash = window.location.hash;
    const currentFull = currentPath + currentHash;
    
    const links = document.querySelectorAll('#navbar-default a');

    links.forEach(link => {
      const href = link.getAttribute('href');
      if (!href) return;

      link.classList.remove('active');

      // Normalizar href del link
      const normalizedHref = normalize(href.split('#')[0]);
      const linkHash = href.includes('#') ? '#' + href.split('#')[1] : '';
      const fullHref = normalizedHref + linkHash;

      // Comparar rutas normalizadas
      if (fullHref === currentFull || normalizedHref === currentPath) {
        link.classList.add('active');
      }
    });
  }

  // Inicializar todo cuando el DOM esté listo
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', () => {
      initNavbar();
      setActiveLink();
    });
  } else {
    // DOM ya está listo
    initNavbar();
    setActiveLink();
  }

  // Actualizar enlace activo en cambios de hash
  window.addEventListener('hashchange', setActiveLink);

  // Re-inicializar después de navegación (para SPAs de Astro)
  document.addEventListener('astro:page-load', () => {
    initNavbar();
    setActiveLink();
  });
</script>